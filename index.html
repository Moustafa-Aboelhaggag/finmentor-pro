<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinMentor Pro | الواجهة الاحترافية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: #F8FAFC; }
        .premium-card { background: white; border-radius: 20px; border: 1px solid #e2e8f0; }
        .loader { width: 20px; height: 20px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black text-slate-900">FinMentor <span class="text-amber-500">Pro</span></h1>
            <nav class="flex gap-4">
                <button id="btn-show-reports" class="text-slate-600 font-bold text-sm">تقاريري</button>
                <button id="btn-new-chat" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold">تحليل جديد</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow p-6">
        <div id="page-chat" class="max-w-4xl mx-auto space-y-6 pb-32">
            <div id="chat-history" class="space-y-6">
                <div class="premium-card p-6 bg-amber-50 border-amber-200">
                    <p class="text-amber-900 font-bold">مرحباً بك في المستشار المالي.</p>
                    <p class="text-amber-800 text-sm">ارفع ميزانيتك أو ملفاتك المالية وسأقوم بتحليلها فوراً عبر خادمنا الآمن.</p>
                </div>
            </div>
        </div>

        <div id="page-reports" class="max-w-7xl mx-auto hidden grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- ستظهر التقارير المخزنة هنا -->
        </div>
    </main>

    <!-- Input Area -->
    <div class="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-slate-50 to-transparent">
        <div class="max-w-3xl mx-auto bg-white border border-slate-200 rounded-2xl shadow-xl p-2">
            <div id="file-preview" class="hidden px-4 py-2 bg-slate-50 rounded-t-xl border-b flex justify-between items-center">
                <span id="file-name" class="text-xs font-bold text-slate-500 truncate"></span>
                <button id="remove-file" class="text-red-500 text-xs">حذف</button>
            </div>
            <div class="flex items-center gap-2">
                <button id="attach-btn" class="p-3 text-slate-400 hover:text-amber-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                </button>
                <input type="file" id="fileInput" class="hidden" accept="image/*,application/pdf">
                <input type="text" id="userInput" placeholder="اسأل عن ميزانيتك..." class="flex-grow p-3 border-none focus:ring-0 outline-none">
                <button id="sendBtn" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-amber-600 transition-colors flex items-center gap-2">
                    <span id="btn-text">إرسال</span>
                    <span id="btn-loader" class="loader hidden"></span>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // إعدادات Firebase (سيتم استبدالها تلقائياً في Canvas أو يدوياً في Vercel)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Fallback config */ };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fin-mentor-prod';

        let user = null;
        let attachedFile = { data: null, type: null, name: "" };

        // Auth
        onAuthStateChanged(auth, u => { user = u; if(!u) signInAnonymously(auth); });

        // File Selection
        document.getElementById('attach-btn').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('fileInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            attachedFile.name = file.name;
            document.getElementById('file-preview').classList.remove('hidden');
            document.getElementById('file-name').innerText = file.name;

            const reader = new FileReader();
            if (file.type.startsWith('image/')) {
                reader.onload = (ev) => { attachedFile.data = ev.target.result.split(',')[1]; attachedFile.type = 'image'; };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                reader.onload = async function() {
                    const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
                    let text = "";
                    for(let i=1; i<=pdf.numPages; i++){
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(s => s.str).join(" ") + "\n";
                    }
                    attachedFile.data = text;
                    attachedFile.type = 'pdf';
                };
                reader.readAsArrayBuffer(file);
            }
        };

        // UI Helpers
        const setUIState = (loading) => {
            document.getElementById('sendBtn').disabled = loading;
            document.getElementById('btn-text').classList.toggle('hidden', loading);
            document.getElementById('btn-loader').classList.toggle('hidden', !loading);
        };

        const renderResponse = (data) => {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = "premium-card p-6 shadow-lg border-r-4 border-amber-500 animate-pulse";
            const canvasId = 'chart-' + Math.random().toString(36).substr(2, 9);
            div.innerHTML = `
                <h3 class="font-black text-xl mb-2">${data.title}</h3>
                <p class="text-slate-600 mb-4 text-sm">${data.summary}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">${data.metrics.map(m => `<div class="bg-slate-50 p-3 rounded-lg flex justify-between text-xs"><span>${m.label}</span><b>${m.value}</b></div>`).join('')}</div>
                    <canvas id="${canvasId}" class="max-h-[150px]"></canvas>
                </div>
            `;
            history.prepend(div);
            new Chart(document.getElementById(canvasId), {
                type: 'bar',
                data: { labels: data.chart.labels, datasets: [{ label: 'القيمة', data: data.chart.values, backgroundColor: '#f59e0b' }] },
                options: { plugins: { legend: { display: false } } }
            });
            div.classList.remove('animate-pulse');
        };

        // Main Send Function
        document.getElementById('sendBtn').onclick = async () => {
            const input = document.getElementById('userInput');
            if (!input.value && !attachedFile.data) return;

            setUIState(true);
            try {
                // الاتصال بـ Serverless Function في المسار النسبي
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: input.value,
                        fileData: attachedFile.data,
                        fileType: attachedFile.type
                    })
                });

                if (!response.ok) throw new Error("API Error");

                const result = await response.json();
                renderResponse(result);

                // حفظ في Firestore
                if (user) {
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'reports'), {
                        ...result, timestamp: serverTimestamp()
                    });
                }

                input.value = "";
                document.getElementById('file-preview').classList.add('hidden');
                attachedFile = { data: null, type: null, name: "" };

            } catch (error) {
                console.error(error);
                alert("حدث خطأ في الخادم أثناء تحليل التقرير.");
            } finally {
                setUIState(false);
            }
        };

    </script>
</body>
</html>