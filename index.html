<!DOCTYPE html>
<html lang="ar" dir="rtl" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinMentor Pro | Financial Intelligence</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            background: #f8fafc;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

<main class="flex-grow pb-32">
    <div id="page-ai-mentor" class="max-w-4xl mx-auto p-6">
        <div id="chat-output" class="space-y-6"></div>
    </div>
</main>

<div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-3xl px-4">
    <div class="bg-white border rounded-2xl shadow-xl p-3 flex gap-3 items-end">
        <textarea id="userInput"
                  class="flex-grow border-none resize-none focus:ring-0 p-3 text-sm"
                  placeholder="اطرح سؤالك المالي هنا..."
                  rows="1"
                  onkeydown="handleEnterKey(event)"></textarea>

        <button onclick="processQuery()"
                id="sendBtn"
                class="bg-slate-900 text-white w-12 h-12 rounded-xl flex items-center justify-center">
            <span id="sendIcon">➤</span>
            <span id="loadingIcon" class="hidden animate-spin">⏳</span>
        </button>
    </div>
</div>

<script>
    let currentLang = "ar";
    let localReports = [];

    const i18n = {
        ar: {
            systemPrompt: "أنت مستشار مالي محترف. قدم تقرير JSON فقط."
        }
    };

    /* ===============================
       الاتصال بالسيرفر (Vercel API)
       =============================== */
    async function fetchAI(payload) {
        const response = await fetch("/api/ai", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error("AI request failed");
        }

        return await response.json();
    }

    async function processQuery() {
        const input = document.getElementById("userInput");
        const text = input.value.trim();
        if (!text) return;

        toggleLoading(true);

        try {
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [{ text }]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: i18n[currentLang].systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json"
                }
            };

            const data = await fetchAI(payload);
            const raw = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            const report = JSON.parse(raw);

            renderReport(report);
            input.value = "";

        } catch (e) {
            showError();
            console.error(e);
        } finally {
            toggleLoading(false);
        }
    }

    function renderReport(data) {
        const html = `
            <div class="bg-white p-6 rounded-2xl shadow">
                <h2 class="text-xl font-bold mb-3">${data.title}</h2>
                <p class="text-slate-600 mb-4">${data.summary}</p>
                <ul class="list-disc pr-6 space-y-2">
                    ${data.recommendations.map(r => `<li>${r}</li>`).join("")}
                </ul>
            </div>
        `;
        document.getElementById("chat-output")
            .insertAdjacentHTML("beforeend", html);
    }

    function toggleLoading(state) {
        document.getElementById("sendIcon").classList.toggle("hidden", state);
        document.getElementById("loadingIcon").classList.toggle("hidden", !state);
        document.getElementById("sendBtn").disabled = state;
    }

    function showError() {
        document.getElementById("chat-output").insertAdjacentHTML(
            "beforeend",
            `<div class="bg-red-50 text-red-600 p-4 rounded-xl text-sm">
                تعذر الاتصال بالذكاء الاصطناعي، حاول مرة أخرى.
            </div>`
        );
    }

    function handleEnterKey(e) {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            processQuery();
        }
    }
</script>

</body>
</html>
